# SPI 测试说明

本文档介绍了 SPI 驱动测试的环境配置、连接方式和测试流程。

## 测试环境

测试使用两个SPI设备进行回环测试：
- **MasterSpi (SPI0)**: 配置为主模式，使用阻塞传输模式
- **SlaveSpi (SPI1)**: 配置为从模式，使用中断传输模式

## 硬件连接

为了进行回环测试，需要将两个SPI设备进行如下连接：

| 信号 | 主设备引脚 (SPI0) | 从设备引脚 (SPI1) | 说明 |
|------|-------------------|-------------------|------|
| SCK  | PB3               | PB13              | 时钟线 |
| MOSI | PB5               | PB15              | 主出从入数据线 |
| MISO | PB4               | PB14              | 主入从出数据线 |
| CS   | N/A               | PE8               | 片选信号，由主设备控制 |

**注意**：
1. 两个SPI设备现在使用不同的物理引脚，确保正确连接对应的引脚进行测试
2. 测试中只使用 `SlaveCsPin` (PE8) 作为片选信号，由主设备控制
3. `MasterCsPin` (PD4) 不参与本次测试

### 重要修改说明

原测试代码中，主设备和从设备都在控制各自的片选引脚，这不符合SPI协议规范。在标准SPI通信中：
- 主设备负责控制从设备的片选信号
- 从设备响应片选信号，不主动控制片选

修复后的代码确保只有主设备控制从设备的片选信号，符合SPI协议规范。

## 连接图示

```
主设备 (SPI0)                从设备 (SPI1)
+-------------+             +-------------+
|             |             |             |
|   SCK (PB3) |------------>| SCK (PB13)  |
|             |             |             |
|  MOSI (PB5) |------------>| MOSI (PB15) |
|             |             |             |
|  MISO (PB4) |<------------| MISO (PB14) |
|             |             |             |
|      [不使用]|             | CS (PE8)    |
|             |             |             |
+-------------+             +-------------+
        |                         ^
        |                         |
        |    主控板 (MCU)          |
+------------------+              |
|                  |              |
| PE8 (片选输出) -------------------------+
|                  |
+------------------+
```

## 测试流程

1. 初始化两个SPI设备和片选引脚
2. 执行基本回环测试：主设备发送，从设备接收
3. 执行全双工测试：主设备和从设备同时收发
4. 测试不同的数据大小、传输模式和时钟速率
5. 测试边缘情况和错误处理

## 片选信号控制逻辑

在修改后的代码中，片选控制逻辑如下：
```cpp
// 主设备控制从设备的片选
void select_slave() {
  SlaveCsPin::clear();  // 主设备拉低从设备的片选（低电平有效）
}

void deselect_slave() {
  SlaveCsPin::set();    // 主设备拉高从设备的片选（高电平无效）
}
```

所有测试函数在开始传输前先调用 `select_slave()`，传输完成后调用 `deselect_slave()`。

## 执行测试

使用以下命令执行所有SPI测试：

```
$ ./run_tests.sh test_spi
```

或在测试程序中调用：

```cpp
RunAllTestsForTestSpi();
``` 